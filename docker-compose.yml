  version: '3'

  services:
    nginx:
      image: nginx:stable
      container_name: nginx
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./nginx/conf.d:/etc/nginx/conf.d
        - ./nginx/ssl:/etc/nginx/ssl
        - ./certbot/www:/var/www/certbot
        - /etc/letsencrypt:/etc/letsencrypt:ro
        - ./nginx/cache:/var/cache/nginx
        - ./nginx/nginx.conf:/etc/nginx/nginx.conf
        - ./nginx/auth:/etc/nginx/auth
      restart: always
      # Enable nginx metrics
      command: ["nginx", "-g", "daemon off;", "-c", "/etc/nginx/nginx.conf"]
      depends_on:
        - gtm-server
        - gtm-server-dreamz
        - gtm-server-preview-dreamz
        - grafana
        - prometheus
      
    # NGINX metrics exporter
    nginx-exporter:
      image: nginx/nginx-prometheus-exporter:latest
      container_name: nginx-exporter
      restart: unless-stopped
      command:
        - '-nginx.scrape-uri=http://nginx/metrics'
      depends_on:
        - nginx
      expose:
        - 9113
    
    gtm-server-dreamz:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-dreamz
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLVcyQzU2TU40JmVudj0xJmF1dGg9N01CenV1M0l4RmM5OEpQVDV5LWtqdw==
        - RUN_AS_PREVIEW_SERVER=false
        - PREVIEW_SERVER_URL=https://gtm-preview.dreamz.com.br
        - LOG_LEVEL=1
      expose:
        - 8080
      depends_on:
        - gtm-server-preview-dreamz
    
    gtm-server-preview-dreamz:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-preview-dreamz
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLVcyQzU2TU40JmVudj0xJmF1dGg9N01CenV1M0l4RmM5OEpQVDV5LWtqdw==
        - RUN_AS_PREVIEW_SERVER=true
        - LOG_LEVEL=1
      expose:
        - 8080
    
    gtm-server-zoppy:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-zoppy
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU43S1Q2UEhTJmVudj0xJmF1dGg9U3pXamNGZmJQRks4R1J4Q3dqNGxjZw==
        - RUN_AS_PREVIEW_SERVER=false
        - PREVIEW_SERVER_URL=https://gtmop.zoppy.com.br
        - LOG_LEVEL=1
      expose:
        - 8080
      depends_on:
        - gtm-server-preview-zoppy
    
    gtm-server-preview-zoppy:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-preview-zoppy
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU43S1Q2UEhTJmVudj0xJmF1dGg9U3pXamNGZmJQRks4R1J4Q3dqNGxjZw==
        - RUN_AS_PREVIEW_SERVER=true
        - LOG_LEVEL=1
      expose:
        - 8080

    gtm-server:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU5KTjhINk04JmVudj0xJmF1dGg9T19BOTNrWEZfQXF3ZDNyZ2RLTVNJdw== 
        - RUN_AS_PREVIEW_SERVER=false
        - PREVIEW_SERVER_URL=https://gtmp.orosdata.com
        - LOG_LEVEL=1
      expose:
        - 8080
      depends_on:
        - gtm-server-preview

    gtm-server-preview:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-preview
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU5KTjhINk04JmVudj0xJmF1dGg9T19BOTNrWEZfQXF3ZDNyZ2RLTVNJdw==
        - RUN_AS_PREVIEW_SERVER=true
        - LOG_LEVEL=1
      expose:
        - 8080

    gtm-server-vidi:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-vidi
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU5MSEI3TEw0JmVudj0xJmF1dGg9UXZqY3d2SzJ2eHBnM3FFOFZrcDNNUQ==
        - RUN_AS_PREVIEW_SERVER=false
        - PREVIEW_SERVER_URL=https://gtmop.segueadii.com.br
        - LOG_LEVEL=1
      expose:
        - 8080
      depends_on:
        - gtm-server-preview-vidi

    gtm-server-preview-vidi:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-preview-vidi
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLU5MSEI3TEw0JmVudj0xJmF1dGg9UXZqY3d2SzJ2eHBnM3FFOFZrcDNNUQ==
        - RUN_AS_PREVIEW_SERVER=true
        - LOG_LEVEL=1
      expose:
        - 8080

    gtm-server-treinarservicos:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-treinarservicos
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLTVUOTdHVEhYJmVudj0xJmF1dGg9anVWM1pfOVJ3TVlxVTJBeG9LRUtHUQ==
        - RUN_AS_PREVIEW_SERVER=false
        - PREVIEW_SERVER_URL=https://gtmop.treinarservicos.com.br
        - LOG_LEVEL=1
      expose:
        - 8080
      depends_on:
        - gtm-server-preview-treinarservicos

    gtm-server-preview-treinarservicos:
      image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
      container_name: gtm-server-preview-treinarservicos
      restart: always
      environment:
        - CONTAINER_CONFIG=aWQ9R1RNLTVUOTdHVEhYJmVudj0xJmF1dGg9anVWM1pfOVJ3TVlxVTJBeG9LRUtHUQ==
        - RUN_AS_PREVIEW_SERVER=true
        - LOG_LEVEL=1
      expose:
        - 8080

    # Node exporter to collect system metrics
    node-exporter:
      image: prom/node-exporter:latest
      container_name: node-exporter
      restart: unless-stopped
      volumes:
        - /proc:/host/proc:ro
        - /sys:/host/sys:ro
        - /:/rootfs:ro
      command:
        - '--path.procfs=/host/proc'
        - '--path.rootfs=/rootfs'
        - '--path.sysfs=/host/sys'
        - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      expose:
        - 9100
        
    # Docker metrics exporter
    cadvisor:
      image: gcr.io/cadvisor/cadvisor:v0.47.0
      container_name: cadvisor
      restart: unless-stopped
      volumes:
        - /:/rootfs:ro
        - /var/run:/var/run:ro
        - /sys:/sys:ro
        - /var/lib/docker/:/var/lib/docker:ro
        - /dev/disk/:/dev/disk:ro
      privileged: true
      devices:
        - /dev/kmsg
      expose:
        - 8080

    uptime-kuma:
      image: louislam/uptime-kuma:latest
      container_name: uptime-kuma
      volumes:
        - uptime-kuma:/app/data
      restart: unless-stopped
      expose:
        - 3001
        
    # Prometheus for metrics collection
    prometheus:
      image: prom/prometheus:latest
      container_name: prometheus
      restart: unless-stopped
      volumes:
        - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
        - prometheus_data:/prometheus
      command:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--web.enable-lifecycle'
      expose:
        - 9090
        
    # Grafana for visualization
    grafana:
      image: grafana/grafana:latest
      container_name: grafana
      restart: unless-stopped
      volumes:
        - grafana_data:/var/lib/grafana
        - ./grafana/provisioning:/etc/grafana/provisioning
      environment:
        - GF_SECURITY_ADMIN_USER=admin
        - GF_SECURITY_ADMIN_PASSWORD=!Trixman25*
        - GF_USERS_ALLOW_SIGN_UP=false
        - GF_SERVER_ROOT_URL=https://server.orosdata.com/grafana
        - GF_SERVER_SERVE_FROM_SUB_PATH=true
        - GF_SERVER_DOMAIN=server.orosdata.com
        - GF_SERVER_ENFORCE_DOMAIN=false
      expose:
        - 3000

  volumes:
    prometheus_data:
    grafana_data:
    uptime-kuma: